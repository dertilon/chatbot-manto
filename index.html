<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación Técnica: Acceso 🔒</title>
</head>
<style>
    /* Paleta Industrial: Negro, Gris Oscuro, Naranja/Amarillo de advertencia */
    :root {
        --color-bg-main: #1c1c1c;
        --color-bg-chat: #2b2b2b;
        --color-accent: #ff9900;
        --color-text-light: #e0e0e0;
        --color-metal-border: #444;
        --color-bot-bg: #3c3c3c;
        --color-link: #4CAF50;
        --color-error: #dc3545;
    }

    /* Estilo de la página */
    body {
        font-family: 'Monospace', 'Courier New', monospace;
        background-color: #0d0d0d;
        color: var(--color-text-light);
        display: flex;
        justify-content: center;
        align-items: flex-start; 
        min-height: 100vh;
        padding: 40px 20px;
        margin: 0;
        background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* Contenedor principal de la Lista de Documentos */
    .chatbot-container {
        width: 100%;
        max-width: 600px;
        background-color: var(--color-bg-main);
        border: 3px solid var(--color-metal-border);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 5px var(--color-accent);
        display: flex;
        flex-direction: column;
        border-radius: 5px;
        overflow: hidden;
    }

    /* Encabezado */
    .chatbot-header {
        background-color: var(--color-metal-border);
        color: var(--color-text-light);
        padding: 15px;
        text-align: center;
        border-bottom: 2px solid var(--color-accent);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .chatbot-header h1 {
        margin: 5px 0 0;
        font-size: 1.4em;
        color: var(--color-accent);
    }

    .chatbot-header p {
        margin: 0;
        font-size: 0.9em;
        color: var(--color-text-light);
    }
    
    /* ******************************************* */
    /* ESTILOS DE LOGIN Y CONTENIDO PRINCIPAL      */
    /* ******************************************* */

    #login-screen {
        padding: 30px;
        text-align: center;
        background-color: var(--color-bg-chat);
    }

    #login-screen h2 {
        color: var(--color-accent);
        margin-top: 0;
    }

    #username-input {
        width: 80%;
        padding: 10px;
        border: 1px solid var(--color-metal-border);
        background-color: #0f0f0f;
        color: var(--color-text-light);
        font-size: 1em;
        font-family: inherit;
        border-radius: 3px;
        margin-bottom: 15px;
    }

    #login-btn {
        background-color: var(--color-accent);
        color: var(--color-bg-main);
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        border-radius: 3px;
        transition: background-color 0.2s;
    }

    #login-btn:hover {
        background-color: #cc7700;
    }

    #login-message {
        margin-top: 15px;
        color: var(--color-error);
        font-weight: bold;
        min-height: 20px;
    }

    /* Contenedor principal del contenido (debe ser flex para el layout interno) */
    #main-content {
        display: none; 
        flex-direction: column; 
        height: 100%; /* Asegura que el contenido ocupe el espacio */
    }

    /* ******************************************* */
    /* ESTILOS DE LISTA (EXISTENTES)               */
    /* ******************************************* */

    #document-list-container {
        flex-grow: 1;
        padding: 15px;
        background-color: var(--color-bg-chat);
        min-height: 400px;
        overflow-y: auto;
        scrollbar-color: var(--color-accent) var(--color-bg-chat);
        scrollbar-width: thin;
    }
    
    #content-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .list-item {
        background-color: var(--color-bot-bg);
        border: 1px solid var(--color-metal-border);
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    
    .machine-item {
        border-left: 5px solid var(--color-accent);
        font-weight: bold;
        color: var(--color-text-light);
    }

    .list-item:hover {
        background-color: #3c3c3c;
        box-shadow: 0 0 8px rgba(255, 153, 0, 0.3);
    }
    
    .file-link {
        text-decoration: none;
        color: var(--color-link);
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1em;
    }
    
    .file-link .file-ext {
        font-size: 0.75em;
        color: var(--color-text-light);
        background-color: #555;
        padding: 3px 6px;
        border-radius: 3px;
    }

    .input-container {
        display: flex;
        justify-content: flex-start;
        padding: 10px 15px;
        border-top: 1px solid var(--color-metal-border);
        background-color: var(--color-bg-main);
    }
    
    #back-btn {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1em;
        border-radius: 3px;
        transition: background-color 0.2s;
        display: none; 
    }

    #back-btn:hover {
        background-color: #777;
    }
    
    .initial-message {
        color: var(--color-accent);
        margin-bottom: 20px;
        padding-bottom: 5px;
        border-bottom: 1px dashed var(--color-metal-border);
        font-size: 1.1em;
    }
</style>
<body>
    <div class="chatbot-container">
        <header class="chatbot-header">
            <i class="fas fa-file-alt"></i>
            <h1>DOCUMENTACIÓN TÉCNICA REMANUFACTURA</h1>
            <p id="header-subtitle">Acceso de Usuario</p>
        </header>

        <div id="login-screen">
            <h2>Ingreso de Usuario 🔒</h2>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="Nombre de Usuario" required onkeypress="if(event.key === 'Enter') checkLogin(event)">
                <button type="button" id="login-btn" onclick="checkLogin()">ACCEDER</button>
            </form>
            <div id="login-message"></div>
        </div>

        <div id="main-content">
            <div class="input-container">
                <button id="back-btn" onclick="renderMachineList()">
                    <i class="fas fa-arrow-left"></i> Volver a la Lista de Máquinas
                </button>
            </div>
            <div id="document-list-container">
            </div>
        </div>
    </div>
    <script>
        const CONFIG = {
            // ************ CORRECCIÓN CLAVE ************
            // Se usa ?gid=...&output=csv para cargar los datos correctamente.
            USERS_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyjYPpbqPVD_0C4A9sfKghjJVyHcRi7GMzizMXe0uxbEZ4ITVnetb9wjdGsQN1CsoHdua1OPmsUVIr/pub?gid=490487396&single=true&output=csv",
            // *******************************************
            // ** URL DE LA APLICACIÓN WEB DE APPS SCRIPT **
            REGISTRO_WEBAPP_URL: "https://script.google.com/macros/s/AKfycbw2ylyFRvNJuVlhSfsGdIQducnR5jK0fgWQA9BlU1aVM01Ho5cTlIVdokebsG3a9G2q/exec", // <--- ¡PEGA AQUÍ TU URL COPIADA!
            // URL DEL ÍNDICE DE ARCHIVOS (Mantenida)
            SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyjYPpbqPVD_0C4A9sfKghjJVyHcRi7GMzizMXe0uxbEZ4ITVnetb9wjdGsQN1CsoHdua1OPmsUVIr/pub?gid=0&single=true&output=csv",
            
            DRIVE_PREVIEW_BASE: "https://drive.google.com/file/d/",
        };
        const state = { 
            machines: [], 
            files: {},
            users: [], 
            isLoggedIn: false,
            currentUser: null
        };
        const $loginScreen = document.getElementById('login-screen');
        const $mainContent = document.getElementById('main-content');
        const $usernameInput = document.getElementById('username-input');
        const $loginMessage = document.getElementById('login-message');
        const $headerSubtitle = document.getElementById('header-subtitle');
        const $listContainer = document.getElementById('document-list-container');
        const $backButton = document.getElementById('back-btn');
        // --- FUNCIÓN DE LIMPIEZA MEJORADA ---
        /**
         * Limpia y estandariza el nombre de usuario eliminando caracteres no alfanuméricos 
         * y convirtiendo a minúsculas.
         */
        function cleanUsername(username) {
            if (!username) return '';
            // Permite letras (a-z) y números (0-9). Elimina todo lo demás (espacios, guiones, puntos).
            return username.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        }
        // --- LÓGICA DE ACCESO (LOGIN) ---
        /**
         * Carga la lista de usuarios desde la hoja 'usuarios'.
         */
        async function loadUsers() {
            $loginMessage.textContent = 'Cargando lista de usuarios...';
            try {
                const res = await fetch(CONFIG.USERS_CSV_URL);
                if (!res.ok) throw new Error("No se pudo cargar la lista de usuarios. (Error de red o publicación)");
                const csv = await res.text();
                
                // Asegúrate de que el CSV no es solo la palabra "Not Found" o un error HTML
                if (csv.length < 50 && !csv.includes(',')) {
                    throw new Error("El archivo CSV está vacío o el GID es incorrecto.");
                }

                const rows = csv.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
                const header = rows.shift().map(h => h.toLowerCase());
                
                const userCol = header.findIndex(h => /usuario|user/.test(h));
                
                if (userCol === -1) {
                    throw new Error("Columna 'Usuario' no encontrada. Verifique el encabezado en su hoja.");
                }

                // Mapea y limpia cada usuario de la hoja para el estado
                state.users = rows.map(r => cleanUsername(r[userCol] || "")).filter(u => u.length > 0);
                
                if (state.users.length === 0) {
                     $loginMessage.textContent = 'Error: No se encontraron usuarios válidos en la hoja. (Revisar datos).';
                     return;
                }

                $loginMessage.textContent = '';
                $usernameInput.focus();
                
            } catch (e) {
                $loginMessage.textContent = `❌ Error de Comunicación: ${e.message}. Revise su URL (USERS_CSV_URL) y la publicación CSV.`;
                console.error("Error cargando usuarios:", e);
            }
        }
        /**
         * Verifica el acceso del usuario.
         */
        function checkLogin(event) {
            if (event && event.type === 'submit') event.preventDefault();
            // Limpiar el input del usuario para la comparación
            const enteredUsername = cleanUsername($usernameInput.value);
            if (state.users.length === 0) {
                $loginMessage.textContent = 'El sistema de usuarios aún no está disponible (error de carga inicial).';
                return;
            }
            if (state.users.includes(enteredUsername)) {
                // Guardamos el nombre original, no la versión limpia, para el saludo
                state.currentUser = $usernameInput.value.trim(); 
                state.isLoggedIn = true;
                // Ocultar login y mostrar contenido principal
                $loginScreen.style.display = 'none';
                $mainContent.style.display = 'flex'; 
                $headerSubtitle.textContent = `Usuario, ${state.currentUser.toUpperCase()}`;
                // Iniciar la carga del índice de documentos
                loadData();
            } else {
                $loginMessage.textContent = '❌ Usuario no válido. Intente de nuevo.';
                $usernameInput.value = '';
                $usernameInput.focus();
            }
            // ... dentro de function checkLogin(event) {
if (state.users.includes(enteredUsername)) {
    // ... código de login exitoso ...
    // 1. Iniciar la carga del índice de documentos
    loadData();
    // 2. REGISTRAR EL ACCESO
    logAccess(state.currentUser); // Usamos el nombre original sin limpiar
} else {
    // ... código de usuario no válido ...
}
// ...
        }
        window.checkLogin = checkLogin; 

        // --- LÓGICA DE ARCHIVOS (MANTENIDA) ---

        async function loadData() {
            $listContainer.innerHTML = '<div class="initial-message">Cargando índice de archivos... <i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch(CONFIG.SHEET_CSV_URL);
                if (!res.ok) throw new Error("No se pudo cargar la hoja. Código: " + res.status);
                const csv = await res.text();
                
                state.machines = [];
                state.files = {};

                const rows = csv.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
                const header = rows.shift().map(h => h.toLowerCase());
                
                const machineCol = header.findIndex(h => /maquina|codigo|machine|code/.test(h));
                
                if(machineCol === -1) {
                    throw new Error("No se encontró la columna de código de máquina en el encabezado del CSV.");
                }

                rows.forEach(r => {
                    const originalCode = (r[machineCol] || "").trim();
                    const cleanCode = originalCode.toUpperCase().replace(/[-_ ]/g, ''); 
                    
                    if (!originalCode || !cleanCode) return;
                    
                    if (!state.files.hasOwnProperty(cleanCode)) {
                        state.machines.push({ clean: cleanCode, original: originalCode }); 
                        state.files[cleanCode] = [];
                    }

                    for(let i = 0; i < r.length; i++) {
                        if (header[i].includes('nombre') && header[i+1] && header[i+1].includes('id')) {
                            const name = r[i];
                            const id = r[i+1];
                            
                            if (name && id) {
                                const ext = name.split('.').pop().toLowerCase();
                                state.files[cleanCode].push({ name, id, ext });
                            }
                        }
                    }
                });
                
                renderMachineList();
                
            } catch (e) {
                console.error("Error cargando lista de archivos:", e);
                $listContainer.innerHTML = `<div class="initial-message" style="color: var(--color-error);">
                    ❌ **ERROR CRÍTICO:** No se pudo cargar el índice de documentos. ${e.message}
                </div>`;
            }
        }

        function renderMachineList() {
            $backButton.style.display = 'none';
            $listContainer.innerHTML = `
                <div class="initial-message">
                    Archivos disponibles (${state.machines.length}):
                </div>
                <ul id="content-list"></ul>
            `;
            
            const $ul = document.getElementById('content-list');

            if (state.machines.length === 0) {
                 $listContainer.innerHTML += '<div class="initial-message">No se encontraron códigos de máquina indexados.</div>';
                 return;
            }
            
            const sortedMachines = [...state.machines].sort((a, b) => a.original.localeCompare(b.original));

            sortedMachines.forEach(machine => {
                const fileCount = state.files[machine.clean].length;
                
                const listItem = document.createElement('li');
                listItem.className = 'list-item machine-item';
                
                listItem.textContent = `⚙️ ${machine.original} (${fileCount} archivos)`;
                
                listItem.addEventListener('click', () => renderFilesList(machine.clean, machine.original));
                
                $ul.appendChild(listItem);
            });
        }
        window.renderMachineList = renderMachineList;

        function renderFilesList(cleanCode, originalCode) {
            const files = state.files[cleanCode] || [];
            
            $backButton.style.display = 'block';
            $listContainer.innerHTML = `
                <div class="initial-message">
                    Archivos <strong>${originalCode}</strong> (${files.length} disponibles):
                </div>
                <ul id="content-list"></ul>
            `;
            
            const $ul = document.getElementById('content-list');
            
            if (files.length === 0) {
                 $listContainer.innerHTML += '<div class="initial-message">No hay archivos asociados a este código.</div>';
                 return;
            }

            files.forEach(fileObj => {
                const fileLink = createLinkElement(fileObj);
                const listItem = document.createElement('li');
                listItem.className = 'list-item';
                listItem.appendChild(fileLink);
                $ul.appendChild(listItem);
            });
        }

        function createLinkElement(fileObj) {
            const { name, id, ext } = fileObj;
            const fullPreviewUrl = CONFIG.DRIVE_PREVIEW_BASE + id + "/view";

            const link = document.createElement('a');
            link.href = fullPreviewUrl;
            link.target = '_blank';
            link.className = 'file-link';
            
            const icon = getFileIcon(name);
            
            link.innerHTML = `
                <span class="file-name">${icon} ${name}</span>
                <span class="file-ext">${ext.toUpperCase()}</span>
            `;
            
            return link;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return '📑'; 
                case 'mp4': return '🎬';
                case 'jpg': case 'jpeg': case 'png': return '🖼️'; 
                case 'doc': case 'docx': return '📝';
                case 'xlsx': case 'xls': return '📊';
                case 'zip': return '📁';
                default: return '📎';
            }
        }

        window.addEventListener('load', loadUsers);
        /**
 * Envía una petición al Apps Script para registrar el usuario y la hora de acceso.
 * @param {string} user - Nombre del usuario.
 */
async function logAccess(user) {
    if (!CONFIG.REGISTRO_WEBAPP_URL) {
        console.error("REGISTRO_WEBAPP_URL no está configurada.");
        return;
    }
    
    try {
        const params = new URLSearchParams({
            usuario: user,
            // Agregamos la IP como 'N/A' porque el script la obtendrá o la marcará como 'N/D'
            ip_address: 'N/A' 
        });

        // Petición POST al Apps Script
        await fetch(CONFIG.REGISTRO_WEBAPP_URL, {
            method: 'POST',
            mode: 'no-cors', // Necesario para evitar errores CORS en implementaciones sencillas
            body: params
        });
        // Nota: No se puede verificar la respuesta debido a 'no-cors', solo asumimos el éxito.
        console.log(`Registro de acceso para ${user} enviado exitosamente.`);
        
    } catch (error) {
        console.error("Error al registrar el acceso:", error);
    }
}
    </script>
</body>
</html>
