<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación Técnica: Seleccionar Máquina ⚙️</title>
</head>
<style>
    /* Paleta Industrial: Negro, Gris Oscuro, Naranja/Amarillo de advertencia */
    :root {
        --color-bg-main: #1c1c1c;
        --color-bg-chat: #2b2b2b;
        --color-accent: #ff9900;
        --color-text-light: #e0e0e0;
        --color-metal-border: #444;
        --color-bot-bg: #3c3c3c;
        --color-link: #4CAF50;
        --color-new-tag: #00bcd4; /* Azul brillante para la etiqueta NUEVO */
    }

    /* Estilo de la página */
    body {
        font-family: 'Monospace', 'Courier New', monospace;
        background-color: #0d0d0d;
        color: var(--color-text-light);
        display: flex;
        justify-content: center;
        align-items: flex-start; 
        min-height: 100vh;
        padding: 40px 20px;
        margin: 0;
        background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* Contenedor principal */
    .chatbot-container {
        width: 100%;
        max-width: 600px;
        background-color: var(--color-bg-main);
        border: 3px solid var(--color-metal-border);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 5px var(--color-accent);
        display: flex;
        flex-direction: column;
        border-radius: 5px;
        overflow: hidden;
    }

    /* Encabezado */
    .chatbot-header {
        background-color: var(--color-metal-border);
        color: var(--color-text-light);
        padding: 15px;
        text-align: center;
        border-bottom: 2px solid var(--color-accent);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .chatbot-header h1 {
        margin: 5px 0 0;
        font-size: 1.4em;
        color: var(--color-accent);
    }

    .chatbot-header p {
        margin: 0;
        font-size: 0.9em;
        color: var(--color-text-light);
    }
    
    /* Ventana de Contenido */
    #document-list-container {
        flex-grow: 1;
        padding: 15px;
        background-color: var(--color-bg-chat);
        min-height: 400px;
        overflow-y: auto;
        scrollbar-color: var(--color-accent) var(--color-bg-chat);
        scrollbar-width: thin;
    }
    
    /* Contenedor general de la lista */
    #content-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* Cada elemento de la lista (Máquina o Archivo) */
    .list-item {
        background-color: var(--color-bot-bg);
        border: 1px solid var(--color-metal-border);
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    
    /* Estilo específico para los códigos de máquina */
    .machine-item {
        border-left: 5px solid var(--color-accent);
        font-weight: bold;
        color: var(--color-text-light);
    }

    .list-item:hover {
        background-color: #3c3c3c;
        box-shadow: 0 0 8px rgba(255, 153, 0, 0.3);
    }
    
    /* Estilo para los links de Archivo */
    .file-link {
        text-decoration: none;
        color: var(--color-link);
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1em;
    }
    
    .file-link .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-link .file-ext {
        font-size: 0.75em;
        color: var(--color-text-light);
        background-color: #555;
        padding: 3px 6px;
        border-radius: 3px;
    }

    /* ******************************************* */
    /* ESTILO PARA LA ETIQUETA NUEVO               */
    /* ******************************************* */
    .new-tag {
        font-size: 0.7em;
        font-weight: bold;
        color: var(--color-bg-main);
        background-color: var(--color-new-tag); 
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 10px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Botón Volver */
    .input-container {
        display: flex;
        justify-content: flex-start;
        padding: 10px 15px;
        border-top: 1px solid var(--color-metal-border);
        background-color: var(--color-bg-main);
    }
    
    #back-btn {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1em;
        border-radius: 3px;
        transition: background-color 0.2s;
        display: none; 
    }

    #back-btn:hover {
        background-color: #777;
    }
    
    .initial-message {
        color: var(--color-accent);
        margin-bottom: 20px;
        padding-bottom: 5px;
        border-bottom: 1px dashed var(--color-metal-border);
        font-size: 1.1em;
    }
</style>
<body>
    <div class="chatbot-container">
        <header class="chatbot-header">
            <i class="fas fa-file-alt"></i>
            <h1>ÍNDICE DE DOCUMENTACIÓN TÉCNICA</h1>
            <p>Selecciona el código de máquina para ver los archivos disponibles.</p>
        </header>

        <div class="input-container">
            <button id="back-btn" onclick="renderMachineList()">
                <i class="fas fa-arrow-left"></i> Volver a la Lista de Máquinas
            </button>
        </div>

        <div id="document-list-container">
        </div>

    </div>
    
    <script>
        const CONFIG = {
            // ** URL DE EXPORTACIÓN CSV (Tu URL) **
            SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyjYPpbqPVD_0C4A9sfKghjJVyHcRi7GMzizMXe0uxbEZ4ITVnetb9wjdGsQN1CsoHdua1OPmsUVIr/pub?gid=0&single=true&output=csv",
            // ** URLs DE GOOGLE DRIVE **
            DRIVE_PREVIEW_BASE: "https://drive.google.com/file/d/",
            // Clave de localStorage para guardar la última visita
            LAST_VISIT_KEY: 'last_document_visit_timestamp' 
        };

        const state = { 
            machines: [], 
            files: {},
            lastVisit: 0 // Fecha de la última visita del usuario
        };

        const $listContainer = document.getElementById('document-list-container');
        const $backButton = document.getElementById('back-btn');
        
        // --- LÓGICA DE FECHAS ---

        /**
         * Comprueba si el archivo es 'nuevo' comparando su fecha con la última visita.
         * @param {string} fileDateString - Fecha de adición del archivo (en formato Date compatible, Ej: YYYY-MM-DD).
         * @returns {boolean}
         */
        function isNewFile(fileDateString) {
            if (!fileDateString) return false;

            const fileTimestamp = new Date(fileDateString).getTime();
            // Consideramos nuevo si el archivo es más reciente que la última visita.
            // Usamos un margen (Ej: 2 días) para asegurar que el archivo se vea como nuevo.
            const GRACE_PERIOD_MS = 2 * 24 * 60 * 60 * 1000; 

            return fileTimestamp > (state.lastVisit - GRACE_PERIOD_MS);
        }

        /**
         * Guarda el timestamp actual como la última visita.
         */
        function updateLastVisit() {
            localStorage.setItem(CONFIG.LAST_VISIT_KEY, Date.now());
            state.lastVisit = Date.now();
        }

        // --- FUNCIONES DE LÓGICA DE ARCHIVOS ---

        /**
         * Carga el índice de máquinas y archivos desde Google Sheets.
         */
        async function loadData() {
            $listContainer.innerHTML = '<div class="initial-message">Cargando índice de archivos... <i class="fas fa-spinner fa-spin"></i></div>';
            
            // 1. Obtener la última visita ANTES de cargar los datos
            state.lastVisit = parseInt(localStorage.getItem(CONFIG.LAST_VISIT_KEY) || '0', 10);

            try {
                const res = await fetch(CONFIG.SHEET_CSV_URL);
                if (!res.ok) throw new Error("No se pudo cargar la hoja. Código: " + res.status);
                const csv = await res.text();
                
                state.machines = [];
                state.files = {};

                const rows = csv.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
                const header = rows.shift().map(h => h.toLowerCase());
                
                const machineCol = header.findIndex(h => /maquina|codigo|machine|code/.test(h));
                // *** NUEVA COLUMNA ***
                const dateCol = header.findIndex(h => /fecha|date|modificaci.n/.test(h)); 
                
                if(machineCol === -1) {
                    throw new Error("No se encontró la columna de código de máquina en el encabezado del CSV.");
                }

                rows.forEach(r => {
                    const originalCode = (r[machineCol] || "").trim();
                    const cleanCode = originalCode.toUpperCase().replace(/[-_ ]/g, ''); 
                    
                    if (!originalCode || !cleanCode) return;
                    
                    if (!state.files.hasOwnProperty(cleanCode)) {
                        state.machines.push({ clean: cleanCode, original: originalCode }); 
                        state.files[cleanCode] = [];
                    }

                    for(let i = 0; i < r.length; i++) {
                        if (header[i].includes('nombre') && header[i+1] && header[i+1].includes('id')) {
                            const name = r[i];
                            const id = r[i+1];
                            const date = dateCol !== -1 ? r[dateCol] : ''; // Captura la fecha

                            if (name && id) {
                                const ext = name.split('.').pop().toLowerCase();
                                state.files[cleanCode].push({ name, id, ext, date }); // Guarda la fecha
                            }
                        }
                    }
                });
                
                // 2. Después de cargar los datos, actualiza la última visita
                updateLastVisit(); 
                
                renderMachineList();
                
            } catch (e) {
                console.error("Error cargando lista de archivos:", e);
                $listContainer.innerHTML = `<div class="initial-message" style="color: #dc3545;">
                    ❌ **ERROR CRÍTICO:** No se pudo cargar la lista. ${e.message}
                </div>`;
            }
        }

        /**
         * Muestra la lista de Códigos de Máquina/Máquinas.
         */
        function renderMachineList() {
            $backButton.style.display = 'none';
            $listContainer.innerHTML = `
                <div class="initial-message">
                    Códigos de Máquina disponibles (${state.machines.length} códigos):
                </div>
                <ul id="content-list"></ul>
            `;
            
            const $ul = document.getElementById('content-list');

            if (state.machines.length === 0) {
                 $listContainer.innerHTML += '<div class="initial-message">No se encontraron códigos de máquina indexados.</div>';
                 return;
            }
            
            const sortedMachines = [...state.machines].sort((a, b) => a.original.localeCompare(b.original));

            sortedMachines.forEach(machine => {
                const files = state.files[machine.clean];
                const fileCount = files.length;
                
                const listItem = document.createElement('li');
                listItem.className = 'list-item machine-item';
                
                // Verificar si hay algún archivo NUEVO en este índice para mostrar el icono en la máquina
                const hasNew = files.some(file => isNewFile(file.date));
                const newTagHtml = hasNew ? '<span class="new-tag">NUEVOS</span>' : '';

                listItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>⚙️ ${machine.original} (${fileCount} archivos)</span>
                        ${newTagHtml}
                    </div>
                `;
                
                listItem.addEventListener('click', () => renderFilesList(machine.clean, machine.original));
                
                $ul.appendChild(listItem);
            });
        }
        
        /**
         * Muestra la lista de Archivos para el código de máquina seleccionado.
         */
        function renderFilesList(cleanCode, originalCode) {
            const files = state.files[cleanCode] || [];
            
            $backButton.style.display = 'block';
            $listContainer.innerHTML = `
                <div class="initial-message">
                    Archivos para la máquina <strong>${originalCode}</strong> (${files.length} disponibles):
                </div>
                <ul id="content-list"></ul>
            `;
            
            const $ul = document.getElementById('content-list');
            
            if (files.length === 0) {
                 $listContainer.innerHTML += '<div class="initial-message">No hay archivos asociados a este código.</div>';
                 return;
            }

            files.forEach(fileObj => {
                const fileLink = createLinkElement(fileObj);
                const listItem = document.createElement('li');
                listItem.className = 'list-item';
                listItem.appendChild(fileLink);
                $ul.appendChild(listItem);
            });
        }


        /**
         * Crea el elemento <a> con la estructura de link y estilos.
         */
        function createLinkElement(fileObj) {
            const { name, id, ext, date } = fileObj;
            
            const fullPreviewUrl = CONFIG.DRIVE_PREVIEW_BASE + id + "/view";

            const link = document.createElement('a');
            link.href = fullPreviewUrl;
            link.target = '_blank';
            link.className = 'file-link';
            
            const icon = getFileIcon(name);
            
            // Lógica y etiqueta NUEVO
            const newTagHtml = isNewFile(date) ? '<span class="new-tag">NUEVO</span>' : '';
            
            link.innerHTML = `
                <div class="file-info">
                    <span class="file-name">${icon} ${name}</span>
                    ${newTagHtml}
                </div>
                <span class="file-ext">${ext.toUpperCase()}</span>
            `;
            
            return link;
        }

        /**
         * Función para obtener un icono representativo del tipo de archivo.
         */
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return '📑'; 
                case 'mp4': return '🎬';
                case 'jpg': case 'jpeg': case 'png': return '🖼️'; 
                case 'doc': case 'docx': return '📝';
                case 'xlsx': case 'xls': return '📊';
                case 'zip': return '📁';
                default: return '📎';
            }
        }


        // Inicializar la aplicación al cargar la ventana
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
