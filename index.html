<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot de Mantenimiento Remanufactura üõ†Ô∏è</title>
</head>
<style>
/* Paleta Industrial: Negro, Gris Oscuro, Naranja/Amarillo de advertencia */
:root {
    --color-bg-main: #1c1c1c; /* Fondo Oscuro */
    --color-bg-chat: #2b2b2b; /* Fondo Chat */
    --color-accent: #ff9900; /* Naranja/Amarillo, color de advertencia/foco */
    --color-text-light: #e0e0e0; /* Texto Claro */
    --color-metal-border: #444; /* Borde Met√°lico */
    --color-bot-bg: #3c3c3c; /* Fondo Bot */
    --color-user-bg: #1f4f6c; /* Fondo Usuario (Azul de planos o seguridad) */
}

/* Estilo de la p√°gina */
body {
    font-family: 'Monospace', 'Courier New', monospace; /* Fuente de Terminal/CLI */
    background-color: #0d0d0d;
    color: var(--color-text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    /* Efecto sutil de ruido o textura met√°lica */
    background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), 
                      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

/* Contenedor principal del Chatbot (simulando un terminal o panel) */
.chatbot-container {
    width: 100%;
    max-width: 450px;
    height: 80vh;
    min-height: 500px;
    background-color: var(--color-bg-main);
    border: 3px solid var(--color-metal-border);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 5px var(--color-accent); /* Sombra con toque de acento */
    display: flex;
    flex-direction: column;
    border-radius: 5px;
    overflow: hidden;
}

/* Encabezado */
.chatbot-header {
    background-color: var(--color-metal-border);
    color: var(--color-text-light);
    padding: 15px;
    text-align: center;
    border-bottom: 2px solid var(--color-accent);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

.chatbot-header h1 {
    margin: 5px 0 0;
    font-size: 1.2em;
    color: var(--color-accent);
}

.chatbot-header p {
    margin: 0;
    font-size: 0.8em;
    color: var(--color-text-light);
}

.chatbot-header i {
    font-size: 1.5em;
    margin-right: 10px;
    color: var(--color-accent);
}

/* Ventana de chat */
.chat-window {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: var(--color-bg-chat);
    border-bottom: 1px dashed var(--color-metal-border);
    /* Estilo de barra de desplazamiento (para navegadores compatibles) */
    scrollbar-color: var(--color-accent) var(--color-bg-chat);
    scrollbar-width: thin;
}

/* Mensajes */
.message {
    padding: 10px 15px;
    border-radius: 3px;
    margin-bottom: 10px;
    max-width: 80%;
    line-height: 1.4;
    font-size: 0.9em;
}

.message p {
    margin: 0;
    white-space: pre-wrap; /* Respeta los saltos de l√≠nea en las respuestas */
}

/* Mensaje del Bot */
.message.bot {
    background-color: var(--color-bot-bg);
    color: var(--color-text-light);
    border-left: 3px solid var(--color-accent);
    margin-right: auto;
}

/* Mensaje del Usuario */
.message.user {
    background-color: var(--color-user-bg);
    color: #fff;
    border-right: 3px solid var(--color-accent);
    margin-left: auto;
    text-align: right;
}

/* Contenedor de entrada (Input) */
.input-container {
    display: flex;
    padding: 15px;
    border-top: 1px solid var(--color-metal-border);
    background-color: var(--color-bg-main);
}

#user-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--color-metal-border);
    background-color: #0f0f0f;
    color: var(--color-text-light);
    font-size: 1em;
    font-family: inherit;
    border-radius: 3px 0 0 3px;
    transition: border-color 0.3s;
}

#user-input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 5px var(--color-accent);
}

/* Bot√≥n de env√≠o */
#send-btn {
    background-color: var(--color-accent);
    color: var(--color-bg-main);
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 0 3px 3px 0;
    transition: background-color 0.2s, opacity 0.2s;
}

#send-btn:hover {
    background-color: #cc7700;
}

#send-btn:active {
    opacity: 0.8;
}
/* --- Estilos para la lista de archivos de Drive (Opciones) --- */

.file-option-group {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 4px;
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    border-left: 2px solid #555;
}

.file-title {
    font-weight: bold;
    color: var(--color-accent);
    flex-basis: 150px; /* Ancho base para el t√≠tulo */
}

.option-btn {
    background: var(--color-accent);
    color: var(--color-bg-main);
    border: none;
    padding: 6px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
    text-decoration: none; 
    transition: background 0.2s;
}

.option-btn:hover {
    background: #cc7700;
}

.download-btn {
    background: #555;
    color: var(--color-text-light);
}

.download-btn:hover {
    background: #777;
}

.media-preview-box {
    margin-top: 10px;
    padding: 10px;
    border: 1px dashed var(--color-accent);
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}
/* Nuevo contenedor para mejorar el layout de la lista de opciones */
.options-list {
  display: flex;
  flex-direction: column; 
  gap: 10px; /* Espacio entre los grupos de archivos */
  margin-top: 5px;
}

/* Estilo para el t√≠tulo de la lista de opciones (Ej: "Respuestas para 1001:") */
.option-title-list {
    font-weight: bold;
    margin-bottom: 5px;
    padding-bottom: 5px;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
}
/* style.css (A√±adir al final) */

/* Ajuste general del input-container para el nuevo bot√≥n */
.input-container {
    display: flex;
    padding: 15px;
    border-top: 1px solid var(--color-metal-border);
    background-color: var(--color-bg-main);
    /* Asegura que los botones y el input compartan espacio */
}


/* Estilo para el bot√≥n de Limpiar */
#clear-btn {
    background-color: var(--color-bot-bg); /* Un gris oscuro */
    color: var(--color-text-light);
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 0; /* Sin borde inicial */
    margin-right: 5px; /* Peque√±a separaci√≥n con el bot√≥n de enviar */
    transition: background-color 0.2s, opacity 0.2s;
    border-radius: 3px 0 0 3px; /* Borde al inicio de la fila de botones */
}

#clear-btn:hover {
    background-color: #555; /* Un gris m√°s claro al pasar el rat√≥n */
}

/* Ajuste al bot√≥n de Enviar para que no tenga borde a la izquierda */
#send-btn {
    /* ... reglas existentes ... */
    border-radius: 0 3px 3px 0; /* Asegura el borde redondeado solo a la derecha */
    margin-left: 0; /* Elimina cualquier margen sobrante */
}

/* Ajuste al input para que tenga margen a la derecha con el nuevo bot√≥n */
#user-input {
    /* ... reglas existentes ... */
    border-radius: 3px 0 0 3px; /* El input tiene el borde redondeado a la izquierda */
    margin-right: 0; /* El bot√≥n de limpiar va pegado al input */
}
</style>
<body>
    <div class="chatbot-container">
        <header class="chatbot-header">
            <i class="fas fa-robot"></i>
            <h1>BOT MANTENIMIENTO V1.0</h1>
            <p>Consulta por M√°quina, Ubicaci√≥n T√©cnica o Falla.</p>
        </header>
        <div id="chat-window" class="chat-window">
            <div class="message bot">
                <p>Hola, soy el Asistente de Mantenimiento. Por favor, ingresa el c√≥digo de M√°quina o la descripci√≥n del problema (ej: "M√°quina: F-010, fallo de lubricaci√≥n").</p>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Escribe tu consulta aqu√≠..." onkeypress="handleKeyPress(event)">
            <button id="clear-btn" onclick="clearChat()">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button id="send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <script>
const CONFIG = {
  // ** URL DE EXPORTACI√ìN CSV CORRECTA **
  // (Debes asegurar que el GID de la hoja con el √≠ndice consolidado sea 59144972)
  SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyjYPpbqPVD_0C4A9sfKghjJVyHcRi7GMzizMXe0uxbEZ4ITVnetb9wjdGsQN1CsoHdua1OPmsUVIr/pub?gid=0&single=true&output=csv",
  
  // ** URLs DE GOOGLE DRIVE **
  DRIVE_DOWNLOAD_BASE: "https://drive.google.com/uc?export=download&id=", 
  DRIVE_PREVIEW_BASE: "https://drive.google.com/file/d/", 

  FALLBACK_TEXT: "No encontr√© archivos indexados para esa m√°quina. Aseg√∫rate de que el c√≥digo de m√°quina exista en la hoja de Google Sheets y que los datos sean correctos.",
  
  SUPPORTED_EXTENSIONS: ['.txt', '.mp4', '.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png']
};

const state = { 
    machines: [], // Lista de c√≥digos de m√°quina
    files: {}     // { '1001': [{name: 'Guia.pdf', id: 'drive_id_1', ext: 'pdf'}, ... ] }
};

// Aseg√∫rate de que los IDs en index.html apunten a los elementos correctos
const $messages = document.getElementById('chat-window'); // Corregido ID de index.html
const $input = document.getElementById('user-input');      // Corregido ID de index.html
const $chatForm = document.querySelector('.input-container'); // Usamos el contenedor o el bot√≥n para el evento (ver nota abajo)
const $sendBtn = document.getElementById('send-btn');


// NOTA: Tu index.html no tiene un <form id="chatForm">, sino un <div class="input-container"> y un onclick="sendMessage()"
// Debemos adaptar la l√≥gica de env√≠o de datos del script anterior a los IDs de tu index.html:

// 1. Usar la funci√≥n de env√≠o de index.html si existe, o reescribir la l√≥gica de evento.
// Como el index.html usa `onclick="sendMessage()"` y `onkeypress="handleKeyPress(event)"`, adaptamos la l√≥gica a esas funciones, asumiendo que el resto del script lo necesita.

// Adaptaci√≥n de los IDs y funciones de env√≠o:

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}
window.handleKeyPress = handleKeyPress;


async function sendMessage() {
    const text = $input.value.trim();
    if (!text) {
        $input.focus();
        return;
    }

    showMessage(text, 'user');
    $input.value = ''; // Limpiamos el campo despu√©s de enviar

    const machine = detectMachineFromText(text);
    
    if (!machine) {
        showMessage('No identifiqu√© un c√≥digo de m√°quina v√°lido. Escriba el c√≥digo exacto, por favor (ej: 1001).', 'bot');
        $input.focus(); 
        return;
    }
    
    const cleanMachine = machine.trim().toUpperCase().replace(/[-_ ]/g, '');

    showMessage(`üîç Buscando opciones para la m√°quina ${cleanMachine}...`, 'bot');
    
    // ** USAMOS EL √çNDICE DE GOOGLE SHEETS **
    const files = getFilesForMachine(cleanMachine); 
    
    if (files.length > 0) {
        showOptions(cleanMachine, files);
    } else {
        showMessage(CONFIG.FALLBACK_TEXT, 'bot');
        $input.focus(); 
    }
}
window.sendMessage = sendMessage;


// Utilidades (el, showMessage, getFileIcon, showOptions, handleViewClick, showMediaPreview, loadMachines, getFilesForMachine, detectMachineFromText)

// Funci√≥n el (Utilidades)
function el(tag, cls, txt) {
  const d = document.createElement(tag);
  if (cls) d.className = cls;
  if (txt) d.textContent = txt;
  return d;
}

/**
 * Muestra un mensaje en el chat.
 */
function showMessage(text, who = 'bot') {
  const m = el('div', 'message ' + (who === 'user' ? 'user' : 'bot'));
  
  // Usamos <p> dentro del mensaje para seguir la estructura de tu style.css
  const p = el('p');
  
  // Permite HTML si es inyectado (como los botones de opciones)
  if (text.includes('<') || text.includes('>')) {
    p.innerHTML = text.replace(/\n/g, '<br>'); 
  } else {
    p.innerText = text;
  }
  m.appendChild(p);

  $messages.appendChild(m);
  $messages.scrollTop = $messages.scrollHeight;
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'txt': return 'üìÑ'; case 'pdf': return 'üìë'; case 'mp4': return 'üé¨';
        case 'jpg': case 'jpeg': case 'png': return 'üñºÔ∏è'; case 'doc': case 'docx': return 'üìù';
        default: return 'üìé';
    }
}
// script.js (A√±adir cerca de las funciones sendMessage y handleViewClick)

// ... resto del c√≥digo ...

/**
 * Limpia todos los mensajes del chat y vuelve a mostrar el saludo inicial.
 */
function clearChat() {
    // 1. Elimina todos los hijos de la ventana de mensajes
    while ($messages.firstChild) {
        $messages.removeChild($messages.firstChild);
    }

    // 2. Muestra el mensaje de bienvenida
    const initialMessage = el('div', 'message bot');
    const p = el('p');
    p.innerHTML = 'Hola, soy el Asistente de Mantenimiento. Por favor, ingresa el c√≥digo de M√°quina o la descripci√≥n del problema (ej: "M√°quina: F-010, fallo de lubricaci√≥n").';
    initialMessage.appendChild(p);
    $messages.appendChild(initialMessage);

    // 3. Vuelve a mostrar la pista de m√°quinas si ya se carg√≥ el √≠ndice
    if (state.machines.length > 0) {
        showMessage(`‚úÖ √çndice de ${state.machines.length} m√°quinas cargado correctamente.`, 'bot');
    }

    $input.focus();
}
window.clearChat = clearChat; // Exportar al scope global para el onclick

// ... resto del c√≥digo ...
/**
 * Muestra la lista de archivos disponibles con botones de Ver/Descargar.
 * Recibe un array de objetos de archivo: [{ name: "doc.pdf", id: "driveID", ext: "pdf" }, ...]
 */
function showOptions(machine, files) {
  // Use a wrapper div for all options instead of injecting raw HTML string directly
  const wrap = el('div', 'msg bot');
  const title = el('div', 'option-title-list');
  title.innerHTML = `<strong>Respuestas para ${machine}:</strong>`;
  wrap.appendChild(title);
  
  const list = el('div', 'options-list'); // Nuevo contenedor para la lista de opciones
  
  files.forEach(fileObj => {
    const file = fileObj.name;
    const fileId = fileObj.id;
    const ext = fileObj.ext;
    
    // Construir URLs de Google Drive
    const fullDownloadUrl = CONFIG.DRIVE_DOWNLOAD_BASE + fileId;
    const fullPreviewUrl = CONFIG.DRIVE_PREVIEW_BASE + fileId + "/preview";
    
    const cleanFileName = file.replace(`.${ext}`, '').replace(/[-_]/g, ' ').toUpperCase();
    const icon = getFileIcon(file);

    // Contenedor de botones para un solo archivo
    const fileContainer = el('div', 'file-option-group'); 

    // T√≠tulo del archivo
    const fileTitle = el('span', 'file-title', icon + ' ' + cleanFileName);
    fileContainer.appendChild(fileTitle);

    // Bot√≥n para Visualizar/Ver 
    const viewBtn = el('button', 'option-btn view-btn', 'üëÅÔ∏è Ver / Abrir');
    
    // Usar addEventListener es m√°s seguro que el 'onclick' en el HTML string
    viewBtn.addEventListener('click', () => {
        handleViewClick(fileId, file, ext);
    });
    fileContainer.appendChild(viewBtn);

    // Bot√≥n para Descargar (usando <a>)
    const downloadBtn = el('a', 'option-btn download-btn');
    downloadBtn.textContent = '‚¨áÔ∏è Descargar';
    downloadBtn.href = fullDownloadUrl;
    downloadBtn.download = file; 
    downloadBtn.target = '_blank'; 

    fileContainer.appendChild(downloadBtn);
    
    list.appendChild(fileContainer);
  });

  wrap.appendChild(list);
  $messages.appendChild(wrap);
  $messages.scrollTop = $messages.scrollHeight;
  $input.focus(); 
}

/**
 * Maneja la visualizaci√≥n del archivo al hacer clic en 'Ver/Abrir'.
 */
function handleViewClick(fileId, filename, ext) {
    showMessage(`(Usuario solicit√≥: Ver ${filename})`, 'user'); 
    
    const fullPreviewUrl = CONFIG.DRIVE_PREVIEW_BASE + fileId + "/preview";
    
    if (['mp4', 'jpg', 'jpeg', 'png'].includes(ext)) {
        // Muestra una vista previa de medios (funci√≥n simplificada para Drive)
        showMediaPreview(fullPreviewUrl, filename, ext);
    } else {
        // Abre el archivo en una nueva pesta√±a (PDF, DOCX, TXT, etc.)
        window.open(fullPreviewUrl, '_blank');
    }
}
window.handleViewClick = handleViewClick; // Exportar al scope global

/**
 * Muestra la vista previa de medios (Simplificado para Google Drive).
 */
function showMediaPreview(url, filename, ext) {
    // Para simplificar la implementaci√≥n en Drive
    
    let mediaHtml = `<div class="media-preview-box">
                       <strong>Vista Previa: ${filename}</strong><br>`;

    if (ext === 'mp4') {
        mediaHtml += `<p>El video de la m√°quina se abrir√° en una nueva pesta√±a. Por favor, revisa tus ventanas.</p>`;
        window.open(url, '_blank'); // Abrir el video directamente
    } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
        mediaHtml += `<p>La imagen se abri√≥ en una nueva pesta√±a. Por favor, revisa tus ventanas.</p>`;
        window.open(url, '_blank'); // Abrir la imagen directamente
    }
    
    mediaHtml += '</div>';
    showMessage(mediaHtml, 'bot');
}

// script.js (Funci√≥n loadMachines MODIFICADA)

/**
 * Carga el √≠ndice de m√°quinas y archivos desde Google Sheets.
 */
async function loadMachines() {
  try {
    const res = await fetch(CONFIG.SHEET_CSV_URL);
    if (!res.ok) throw new Error("No se pudo cargar la hoja. C√≥digo: " + res.status);
    const csv = await res.text();
    
    // Procesa el CSV
    const rows = csv.trim().split("\n").map(r => r.split(",").map(c => c.trim()));
    const header = rows.shift().map(h => h.toLowerCase());
    
    const machineCol = header.findIndex(h => /maquina|codigo|machine|code/.test(h));
    
    rows.forEach(r => {
      const machineCode = (r[machineCol] || r[0] || "").trim().toUpperCase().replace(/[-_ ]/g, '');
      if (!machineCode) return;
      
      state.machines.push(machineCode);
      state.files[machineCode] = [];

      // Itera sobre las columnas para encontrar los pares (Nombre, ID)
      for(let i = 0; i < r.length; i++) {
        // Asume que la columna Nombre y ID tienen un encabezado que incluye 'nombre' y 'id' respectivamente
        if (header[i].includes('nombre') && header[i+1] && header[i+1].includes('id')) {
             const name = r[i];
             const id = r[i+1];
             
             if (name && id) {
                 const ext = name.split('.').pop().toLowerCase();
                 state.files[machineCode].push({ name, id, ext });
             }
        }
      }
    });
    
    // Muestra una pista de las m√°quinas cargadas
    const hintText = state.machines.slice(0, 6).join(", ") + (state.machines.length > 6 ? ", etc." : "");

    // *** MODIFICACI√ìN CLAVE AQU√ç ***
    showMessage(`‚úÖ ${state.machines.length} M√°quinas cargadas`, 'bot');
    
    if (state.machines.length > 0) {
        showMessage(`C√≥digos disponibles: **${hintText}**`, 'bot');
    }
    // *** FIN MODIFICACI√ìN ***

    $input.focus(); 
  } catch (e) {
    console.warn("Error cargando lista de m√°quinas:", e);
    showMessage("‚ùå **ERROR CR√çTICO:** No se pudo cargar la lista de m√°quinas desde Google Sheets. Revisa la consola y los permisos del archivo.", 'bot');
  }
}

/**
 * Funci√≥n para obtener archivos desde el estado (reemplaza listFilesForMachine)
 */
function getFilesForMachine(machine) {
    const cleanMachine = machine.trim().toUpperCase().replace(/[-_ ]/g, '');
    return state.files[cleanMachine] || [];
}

/**
 * Funci√≥n mejorada para detectar el c√≥digo de m√°quina.
 */
function detectMachineFromText(text) {
  const t = text.toLowerCase().trim().replace(/[-_ ]/g, '');
  
  // 1. Detecci√≥n basada en la lista de m√°quinas cargadas
  for (const m of state.machines) {
    if (t.includes(m.toLowerCase().replace(/[-_ ]/g, ''))) return m;
  }
  
  // 2. Detecci√≥n de un patr√≥n de c√≥digo gen√©rico
  const codeMatch = text.match(/\b[a-z0-9]{1,10}\b/i);

  if (codeMatch) {
      return codeMatch[0].toUpperCase().replace(/[-_ ]/g, '');
  }
  
  return null;
}

// Inicializar la aplicaci√≥n
window.addEventListener('load', loadMachines);
    </script>
</body>

</html>
